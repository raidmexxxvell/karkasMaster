<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Profile — WebApp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
</head>
<body>
  <div id="profile">
    <img id="avatar" src="" alt="avatar" style="width:96px;height:96px;border-radius:50%;object-fit:cover"/>
    <div id="name" style="font-weight:600;font-size:18px;margin-top:8px"></div>
    <div id="username" style="color:#666"></div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function(){
      const tg = window.Telegram.WebApp;
      tg.ready();

      // Быстро показать из initDataUnsafe (не доверять на сервер)
      const unsafeUser = tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (unsafeUser) {
        const full = ((unsafeUser.first_name||'') + (unsafeUser.last_name ? ' ' + unsafeUser.last_name : '')).trim();
        document.getElementById('name').textContent = full || '';
        document.getElementById('username').textContent = unsafeUser.username ? '@' + unsafeUser.username : '';
        if (unsafeUser.photo_url) document.getElementById('avatar').src = unsafeUser.photo_url;
      }

      // Отправляем signed initData на сервер для проверки и загрузки фото через Bot API
      fetch('/webapp/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: tg.initData })
      })
      .then(r => r.json())
      .then(data => {
        if (!data || !data.ok) {
          console.warn('init validation failed', data);
          return;
        }
        const user = data.user || {};
        if (user.full_name) document.getElementById('name').textContent = user.full_name;
        if (user.username) document.getElementById('username').textContent = '@' + user.username;
        if (data.photo_url) document.getElementById('avatar').src = data.photo_url;
      })
      .catch(err => console.error('webapp init error', err));
    })();
  </script>
</body>
</html>
