{% extends 'base.html' %}
{% block title %}Встроенное приложение{% endblock %}
{% block content %}
<!-- Верхняя навигация убрана; используем нижнее меню -->
<section id="tab-projects" class="tab" role="tabpanel" tabindex="0" aria-labelledby="projects-tab">
  <h2>Проекты</h2>
  <div id="projects-list">Загрузка...</div>
</section>
<section id="tab-profile" class="tab" style="display:none" role="tabpanel" tabindex="0" aria-labelledby="profile-tab">
  <h2>Мой профиль</h2>
  <div id="profile-block">Загрузка профиля...</div>
  <div id="telegram-login"></div>
</section>
<section id="tab-chats" class="tab" style="display:none" role="tabpanel" tabindex="0" aria-labelledby="chats-tab">
  <h2>Чаты</h2>
  <div id="chats-block">Список чатов...</div>
</section>
<section id="tab-help" class="tab" style="display:none" role="tabpanel" tabindex="0" aria-labelledby="help-tab">
  <h2>Помощь</h2>
  <p>Инструкция по использованию бота и приложения.</p>
</section>

<!-- Splash / loading screen -->
<div id="splash" aria-hidden="false" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:9999">
  <div style="text-align:center;max-width:320px;width:100%">
    <img src="/static/images/logo.png" alt="logo" style="width:120px;height:120px;margin:0 auto;display:block">
    <div style="margin-top:12px;font-weight:600">Загрузка...</div>
    <div style="margin-top:12px;background:#eee;border-radius:8px;padding:6px">
      <div id="splash-bar" style="height:10px;background:#000;width:0%;border-radius:6px;transition:width 300ms ease"></div>
    </div>
    <div id="splash-percent" style="margin-top:8px;color:var(--muted)">0%</div>
  </div>
</div>
<script>
// простая логика вкладок и загрузка профиля
(function(){
  function showTab(name){
    document.querySelectorAll('.tab').forEach(el=>{
      el.style.display='none';
      el.style.opacity=0;
      el.setAttribute('aria-hidden','true');
    });
    var panel = document.getElementById('tab-'+name);
    if(panel){
      panel.style.display='block';
      // allow CSS transition to animate opacity
      setTimeout(()=>{ panel.style.opacity = 1; }, 20);
      panel.setAttribute('aria-hidden','false');
      panel.focus();
    }
    history.replaceState(null,'', '#'+name);
    // mark active in global bottom nav and manage aria-selected
    try{
      document.querySelectorAll('#global-bottom-nav .tab-link').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      var btn = document.querySelector('#global-bottom-nav .tab-link[data-tab="'+name+'"]');
      if(btn){ btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
    }catch(e){}
  }

  // keyboard support for tab navigation
  (function(){
    var nav = document.getElementById('global-bottom-nav');
    if(!nav) return;
    nav.addEventListener('keydown', function(e){
      var keys = {37:'left',39:'right',36:'home',35:'end'};
      var key = keys[e.keyCode];
      if(!key) return;
      var tabs = Array.from(nav.querySelectorAll('.tab-link'));
      var idx = tabs.findIndex(t=>t.classList.contains('active'));
      if(idx<0) idx = 0;
      if(key==='left') idx = (idx-1+tabs.length)%tabs.length;
      if(key==='right') idx = (idx+1)%tabs.length;
      if(key==='home') idx = 0;
      if(key==='end') idx = tabs.length-1;
      tabs[idx].focus();
      showTab(tabs[idx].dataset.tab);
      e.preventDefault();
    });
  })();
  // Сначала читаем параметр st из URL (редирект после /auth/telegram)
  var params = new URLSearchParams(window.location.search);
  var urlSt = params.get('st') || params.get('token');
  if(urlSt){
    localStorage.setItem('st', urlSt);
    // очищаем параметр из адресной строки
    history.replaceState(null, '', window.location.pathname + window.location.hash);
  }
  var token = localStorage.getItem('st');
  function loadProjects(){
    fetch('/api/projects').then(r=>r.json()).then(arr=>{
      const el = document.getElementById('projects-list'); el.innerHTML='';
      arr.forEach(p=>{ const d=document.createElement('div'); d.innerHTML=`<h3>${p.title}</h3><p>${p.description}</p><button onclick="join(${p.id})">Прикрепиться</button>`; el.appendChild(d); });
    });
  }
  window.join = function(id){
    var currentToken = localStorage.getItem('st');
    if(!currentToken){ alert('Войдите через Telegram чтобы выполнить действие'); return; }
    fetch(`/api/project/${id}/message`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({telegram_id:currentToken, text:'Пользователь через веб UI присоединился'})}).then(()=>alert('Запрос отправлен')).catch(()=>alert('Ошибка отправки'));
  }
  function loadProfile(){
    return new Promise((resolve, reject)=>{
      var el = document.getElementById('profile-block');
      var currentToken = localStorage.getItem('st');
      if(!currentToken){ el.innerHTML = '<a href="/auth/telegram?next=/">Войти через Telegram</a>'; resolve(); return; }
      fetch('/api/me?st='+currentToken).then(r=>r.json()).then(d=>{
        if(d.error){ el.innerHTML = '<a href="/auth/telegram?next=/">Войти через Telegram</a>'; resolve(); return; }
        var photo = d.photo_url || '';
        var first = d.first_seen ? new Date(d.first_seen).toLocaleString() : '';
        // create image element and wait for load (with timeout)
        function applyProfile(src){
          el.innerHTML = `<div class="profile">` + (src?`<img src="${src}" alt="avatar">`:`<div style="width:72px;height:72px;border-radius:999px;background:#efefef"></div>`) + `<div class="meta"><div class="name">${d.name || 'Пользователь'}</div><div class="id">telegram: ${d.telegram_id}</div><div class="small">Первый вход: ${first}</div></div></div>`;
          resolve();
        }
        if(photo){
          var img = new Image();
          var settled = false;
          var to = setTimeout(()=>{ if(!settled){ settled=true; applyProfile('/static/images/avatar.png'); } }, 4000);
          img.onload = function(){ if(!settled){ settled=true; clearTimeout(to); applyProfile(photo); } };
          img.onerror = function(){ if(!settled){ settled=true; clearTimeout(to); applyProfile('/static/images/avatar.png'); } };
          img.src = photo;
        } else {
          applyProfile('/static/images/avatar.png');
        }
      }).catch(()=>{ el.innerHTML = '<div class="small">Не удалось загрузить профиль</div>'; resolve(); });
    });
  }
  window.addEventListener('load', ()=>{
    var hash = location.hash.replace('#','') || 'projects';
    showTab(hash);
    document.querySelectorAll('.tab-link').forEach(btn=>btn.addEventListener('click', function(e){ showTab(this.dataset.tab); }));
    loadProjects();
    // show splash while loading profile
    runSplashLoad();
  });
})();

async function runSplashLoad(){
  var bar = document.getElementById('splash-bar');
  var pct = document.getElementById('splash-percent');
  // initial animation to 30%
  bar.style.width = '30%'; pct.innerText = '30%';
  try{
    // start loading profile
    await loadProfile();
    // after profile loaded, advance to 85%
    bar.style.width = '85%'; pct.innerText = '85%';
    // small delay to show progress
    await new Promise(r=>setTimeout(r, 500));
    bar.style.width = '100%'; pct.innerText = '100%';
    await new Promise(r=>setTimeout(r, 250));
  }catch(e){
    // still finish
    bar.style.width = '100%'; pct.innerText = '100%';
    await new Promise(r=>setTimeout(r, 500));
  } finally{
    var sp = document.getElementById('splash');
    if(sp) sp.style.display = 'none';
  }
}
</script>
{% endblock %}

<!-- Нижнее меню (вставляется после SPA) -->
{% block extra %}
<nav class="bottom-nav">
  <button type="button" class="tab-link" data-tab="projects">Проекты</button>
  <button type="button" class="tab-link" data-tab="profile">Мой профиль</button>
  <button type="button" class="tab-link" data-tab="chats">Чаты</button>
  <button type="button" class="tab-link" data-tab="help">Помощь</button>
</nav>
{% endblock %}
